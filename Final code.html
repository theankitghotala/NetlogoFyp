<pre><font color="#007f69">patches-own</font><font color="#000000"> [<br />  psugar<br />  max-psugar<br />  pspice<br />  max-pspice<br />]<br /></font><font color="#007f69">turtles-own</font><font color="#000000"> [<br />  sugar<br />  spice<br />  sugar-metabolism<br />  spice-metabolism<br />  vision<br />  vision-points<br />  sex<br />  age<br />  max-age<br />  culture<br />  group-id<br />  aggression<br />]<br /></font><font color="#007f69">globals</font><font color="#000000"> [<br />  tax-pool<br />]<br /></font><font color="#007f69">to</font><font color="#000000"> setup<br />  </font><font color="#0000aa">clear-all</font><font color="#000000"><br />  </font><font color="#0000aa">set</font><font color="#000000"> tax-pool </font><font color="#963700">0</font><font color="#000000"><br />  setup-patches<br />  setup-turtles<br />  </font><font color="#5a5a5a">;;setup-gini-graph</font><font color="#000000"><br />  </font><font color="#0000aa">reset-ticks</font><font color="#000000"><br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> setup-patches<br />  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000">[<br />    </font><font color="#0000aa">set</font><font color="#000000"> max-psugar </font><font color="#660096">one-of</font><font color="#000000">[</font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]<br />    </font><font color="#0000aa">set</font><font color="#000000"> psugar max-psugar<br />    </font><font color="#0000aa">set</font><font color="#000000"> max-pspice </font><font color="#660096">one-of</font><font color="#000000">[</font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]<br />    </font><font color="#0000aa">set</font><font color="#000000"> pspice max-pspice<br />    recolor-patch<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> setup-turtles<br />  </font><font color="#0000aa">create-turtles</font><font color="#000000"> </font><font color="#963700">50</font><font color="#000000">[<br />    </font><font color="#0000aa">setxy</font><font color="#000000"> </font><font color="#660096">random-xcor</font><font color="#000000"> </font><font color="#660096">random-ycor</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">red</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">shape</font><font color="#000000"> </font><font color="#963700">&quot;square&quot;</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> sugar </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">20</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> sugar-metabolism </font><font color="#660096">one-of</font><font color="#000000">[</font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]<br />    </font><font color="#0000aa">set</font><font color="#000000"> spice </font><font color="#963700">30</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">30</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> spice-metabolism </font><font color="#660096">one-of</font><font color="#000000">[</font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]<br />    </font><font color="#0000aa">set</font><font color="#000000"> vision </font><font color="#660096">one-of</font><font color="#000000">[</font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]<br />    </font><font color="#0000aa">set</font><font color="#000000"> age </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> max-age </font><font color="#963700">60</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">40</font><font color="#000000"><br />    </font><font color="#0000aa">set</font><font color="#000000"> culture </font><font color="#660096">n-values</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> [</font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000">]<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> go<br />  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">not</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"> [</font><font color="#0000aa">stop</font><font color="#000000">]<br />  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"> [ move eat check-death update-label update-color age-and-reproduce trade pay-progressive-tax interact-culture spread-disease ]<br />  </font><font color="#0000aa">ask</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> [ patch-growback recolor-patch ]<br />  redistribute-tax<br />  calculate-gini<br />  </font><font color="#0000aa">tick</font><font color="#000000"><br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> move<br />  </font><font color="#0000aa">let</font><font color="#000000"> best-patch </font><font color="#660096">max-one-of</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> </font><font color="#660096">in-radius</font><font color="#000000"> vision [psugar </font><font color="#660096">+</font><font color="#000000"> pspice]<br />  </font><font color="#0000aa">if</font><font color="#000000"> best-patch </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">nobody</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> (psugar </font><font color="#660096">+</font><font color="#000000"> pspice) </font><font color="#660096">&lt;</font><font color="#000000"> ([psugar] </font><font color="#660096">of</font><font color="#000000"> best-patch </font><font color="#660096">+</font><font color="#000000"> [pspice] </font><font color="#660096">of</font><font color="#000000"> best-patch) [<br />     </font><font color="#0000aa">move-to</font><font color="#000000"> best-patch<br />  ]<br />  resolve-conflict<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> eat<br />  </font><font color="#0000aa">set</font><font color="#000000"> sugar (sugar </font><font color="#660096">-</font><font color="#000000"> sugar-metabolism </font><font color="#660096">+</font><font color="#000000"> psugar)<br />  </font><font color="#0000aa">set</font><font color="#000000"> psugar </font><font color="#963700">0</font><font color="#000000"><br />  </font><font color="#0000aa">set</font><font color="#000000"> spice (spice </font><font color="#660096">-</font><font color="#000000"> spice-metabolism </font><font color="#660096">+</font><font color="#000000"> pspice)<br />  </font><font color="#0000aa">set</font><font color="#000000"> pspice </font><font color="#963700">0</font><font color="#000000"><br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> check-death<br />  </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&lt;=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">or</font><font color="#000000"> spice </font><font color="#660096">&lt;=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [</font><font color="#0000aa">die</font><font color="#000000">]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> recolor-patch<br />  </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">pcolor</font><font color="#000000"> (</font><font color="#963700">white</font><font color="#000000"> </font><font color="#660096">-</font><font color="#000000"> psugar)  </font><font color="#5a5a5a">;; More sugar = brighter</font><font color="#000000"><br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> update-label<br />  </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">label</font><font color="#000000"> sugar<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> update-color<br />  </font><font color="#0000aa">let</font><font color="#000000"> culture-sum </font><font color="#660096">sum</font><font color="#000000"> culture<br />  </font><font color="#0000aa">if</font><font color="#000000"> culture-sum </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">blue</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> culture-sum </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">cyan</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> culture-sum </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">magenta</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> culture-sum </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">3</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">yellow</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> culture-sum </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">4</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">pink</font><font color="#000000"> ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> patch-growback<br />  </font><font color="#0000aa">if</font><font color="#000000"> psugar </font><font color="#660096">&lt;</font><font color="#000000"> max-psugar [ </font><font color="#0000aa">set</font><font color="#000000"> psugar psugar </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> pspice </font><font color="#660096">&lt;</font><font color="#000000"> max-pspice [ </font><font color="#0000aa">set</font><font color="#000000"> pspice pspice </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> age-and-reproduce<br />  </font><font color="#0000aa">set</font><font color="#000000"> age age </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> age </font><font color="#660096">&gt;=</font><font color="#000000"> max-age [ </font><font color="#0000aa">die</font><font color="#000000"> ]  </font><font color="#5a5a5a">;; Agents die of old age</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> age </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">15</font><font color="#000000"> [ <br />    </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">30</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> spice </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">20</font><font color="#000000"> [<br />    </font><font color="#0000aa">hatch</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> [<br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar-metabolism sugar-metabolism </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> [</font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">]<br />      </font><font color="#0000aa">set</font><font color="#000000"> spice-metabolism spice-metabolism </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> [</font><font color="#963700">-1</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">]<br />      </font><font color="#0000aa">set</font><font color="#000000"> vision </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">random</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> age </font><font color="#963700">0</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> max-age </font><font color="#660096">max</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> </font><font color="#963700">20</font><font color="#000000"> (max-age </font><font color="#660096">+</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> [</font><font color="#963700">-5</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#963700">5</font><font color="#000000">]))<br />      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">red</font><font color="#000000"><br />    ]<br />    </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">/</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />  ]<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> calculate-gini<br />  </font><font color="#0000aa">let</font><font color="#000000"> sugar-values [sugar] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"><br />  </font><font color="#0000aa">let</font><font color="#000000"> spice-values [spice] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"><br />  </font><font color="#0000aa">let</font><font color="#000000"> total-wealth-values [sugar </font><font color="#660096">+</font><font color="#000000"> spice] </font><font color="#660096">of</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"><br /><br /><br />  </font><font color="#0000aa">let</font><font color="#000000"> sugar-gini compute-gini sugar-values<br />  </font><font color="#0000aa">let</font><font color="#000000"> spice-gini compute-gini spice-values<br />  </font><font color="#0000aa">let</font><font color="#000000"> total-gini compute-gini total-wealth-values<br /><br />  </font><font color="#0000aa">set-current-plot</font><font color="#000000"> </font><font color="#963700">&quot;Gini Coefficient&quot;</font><font color="#000000"><br />  </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Sugar&quot;</font><font color="#000000"><br />  </font><font color="#0000aa">plot</font><font color="#000000"> sugar-gini<br /><br />  </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Spice&quot;</font><font color="#000000"><br />  </font><font color="#0000aa">plot</font><font color="#000000"> spice-gini<br /><br />  </font><font color="#0000aa">set-current-plot-pen</font><font color="#000000"> </font><font color="#963700">&quot;Total Wealth&quot;</font><font color="#000000"><br />  </font><font color="#0000aa">plot</font><font color="#000000"> total-gini<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to-report</font><font color="#000000"> compute-gini [values]<br />  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">length</font><font color="#000000"> values </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#0000aa">report</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ]<br />  <br />  </font><font color="#0000aa">let</font><font color="#000000"> sorted-values </font><font color="#660096">sort</font><font color="#000000"> values<br />  </font><font color="#0000aa">let</font><font color="#000000"> n </font><font color="#660096">length</font><font color="#000000"> sorted-values<br />  </font><font color="#0000aa">let</font><font color="#000000"> total </font><font color="#660096">sum</font><font color="#000000"> sorted-values<br />  </font><font color="#0000aa">if</font><font color="#000000"> total </font><font color="#660096">=</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [ </font><font color="#0000aa">report</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> ]  </font><font color="#5a5a5a">;; Avoid division by zero</font><font color="#000000"><br /><br />  </font><font color="#0000aa">let</font><font color="#000000"> cumulative-sum </font><font color="#963700">0</font><font color="#000000"><br />  </font><font color="#0000aa">let</font><font color="#000000"> weighted-sum </font><font color="#963700">0</font><font color="#000000"><br /><br />  </font><font color="#5a5a5a">;; Calculate cumulative weighted sum</font><font color="#000000"><br />  (</font><font color="#0000aa">foreach</font><font color="#000000"> sorted-values [val -&gt; <br />    </font><font color="#0000aa">set</font><font color="#000000"> cumulative-sum cumulative-sum </font><font color="#660096">+</font><font color="#000000"> val<br />    </font><font color="#0000aa">set</font><font color="#000000"> weighted-sum weighted-sum </font><font color="#660096">+</font><font color="#000000"> cumulative-sum<br />  ])<br /><br />  </font><font color="#5a5a5a">;; Compute Gini coefficient using the correct formula</font><font color="#000000"><br />  </font><font color="#0000aa">let</font><font color="#000000"> gini (</font><font color="#963700">2</font><font color="#000000"> </font><font color="#660096">*</font><font color="#000000"> weighted-sum) </font><font color="#660096">/</font><font color="#000000"> (n </font><font color="#660096">*</font><font color="#000000"> total) </font><font color="#660096">-</font><font color="#000000"> (n </font><font color="#660096">+</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000">) </font><font color="#660096">/</font><font color="#000000"> n<br />  </font><font color="#0000aa">report</font><font color="#000000"> gini<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> trade<br />  </font><font color="#0000aa">let</font><font color="#000000"> neighbor </font><font color="#660096">one-of</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"> </font><font color="#660096">in-radius</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> neighbor </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">nobody</font><font color="#000000"> [<br />    <br />    </font><font color="#5a5a5a">;; Determine excess and need for sugar</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> my-sugar-need sugar-metabolism </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> neighbor-sugar-need [sugar-metabolism] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> my-excess-sugar </font><font color="#660096">max</font><font color="#000000"> </font><font color="#660096">list</font><font color="#000000"> (sugar </font><font color="#660096">-</font><font color="#000000"> my-sugar-need) </font><font color="#963700">0</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> neighbor-excess-sugar </font><font color="#660096">max</font><font color="#000000"> </font><font color="#660096">list</font><font color="#000000"> ([sugar] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">-</font><font color="#000000"> neighbor-sugar-need) </font><font color="#963700">0</font><font color="#000000"><br /><br />    </font><font color="#5a5a5a">;; Determine excess and need for spice</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> my-spice-need spice-metabolism </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> neighbor-spice-need [spice-metabolism] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> my-excess-spice </font><font color="#660096">max</font><font color="#000000"> </font><font color="#660096">list</font><font color="#000000"> (spice </font><font color="#660096">-</font><font color="#000000"> my-spice-need) </font><font color="#963700">0</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> neighbor-excess-spice </font><font color="#660096">max</font><font color="#000000"> </font><font color="#660096">list</font><font color="#000000"> ([spice] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">-</font><font color="#000000"> neighbor-spice-need) </font><font color="#963700">0</font><font color="#000000"><br /><br />    </font><font color="#5a5a5a">;; Direct sugar-to-sugar trade (same as before)</font><font color="#000000"><br />    </font><font color="#0000aa">if</font><font color="#000000"> (my-excess-sugar </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> [sugar] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">&lt;</font><font color="#000000"> neighbor-sugar-need) [<br />      </font><font color="#0000aa">let</font><font color="#000000"> trade-amount </font><font color="#660096">min</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> my-excess-sugar (neighbor-sugar-need </font><font color="#660096">-</font><font color="#000000"> [sugar] </font><font color="#660096">of</font><font color="#000000"> neighbor))<br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">ask</font><font color="#000000"> neighbor [ </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">+</font><font color="#000000"> trade-amount ]<br />    ]<br /><br />    </font><font color="#5a5a5a">;; Direct spice-to-spice trade (same as before)</font><font color="#000000"><br />    </font><font color="#0000aa">if</font><font color="#000000"> (my-excess-spice </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> [spice] </font><font color="#660096">of</font><font color="#000000"> neighbor </font><font color="#660096">&lt;</font><font color="#000000"> neighbor-spice-need) [<br />      </font><font color="#0000aa">let</font><font color="#000000"> trade-amount </font><font color="#660096">min</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> my-excess-spice (neighbor-spice-need </font><font color="#660096">-</font><font color="#000000"> [spice] </font><font color="#660096">of</font><font color="#000000"> neighbor))<br />      </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">ask</font><font color="#000000"> neighbor [ </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">+</font><font color="#000000"> trade-amount ]<br />    ]<br /><br />    </font><font color="#5a5a5a">;; Bartering: trade sugar for spice</font><font color="#000000"><br />    </font><font color="#0000aa">if</font><font color="#000000"> (my-excess-sugar </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> neighbor-excess-spice </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) [<br />      </font><font color="#0000aa">let</font><font color="#000000"> trade-amount </font><font color="#660096">min</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> my-excess-sugar neighbor-excess-spice)<br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">+</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">ask</font><font color="#000000"> neighbor [<br />        </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">+</font><font color="#000000"> trade-amount<br />        </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      ]<br />    ]<br /><br />    </font><font color="#5a5a5a">;; Bartering: trade spice for sugar</font><font color="#000000"><br />    </font><font color="#0000aa">if</font><font color="#000000"> (my-excess-spice </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> neighbor-excess-sugar </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000">) [<br />      </font><font color="#0000aa">let</font><font color="#000000"> trade-amount </font><font color="#660096">min</font><font color="#000000"> (</font><font color="#660096">list</font><font color="#000000"> my-excess-spice neighbor-excess-sugar)<br />      </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">+</font><font color="#000000"> trade-amount<br />      </font><font color="#0000aa">ask</font><font color="#000000"> neighbor [<br />        </font><font color="#0000aa">set</font><font color="#000000"> spice spice </font><font color="#660096">+</font><font color="#000000"> trade-amount<br />        </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">-</font><font color="#000000"> trade-amount<br />      ]<br />    ]<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> pay-progressive-tax <br />  </font><font color="#0000aa">let</font><font color="#000000"> tax-rate </font><font color="#963700">0.1</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">30</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> tax-rate </font><font color="#963700">0.2</font><font color="#000000"> ]<br />  </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">50</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> tax-rate </font><font color="#963700">0.3</font><font color="#000000"> ]<br />  <br />  </font><font color="#0000aa">let</font><font color="#000000"> tax-amount sugar </font><font color="#660096">*</font><font color="#000000"> tax-rate<br />  </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">-</font><font color="#000000"> tax-amount<br />  </font><font color="#0000aa">set</font><font color="#000000"> tax-pool tax-pool </font><font color="#660096">+</font><font color="#000000"> tax-amount<br />  <br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> redistribute-tax<br />  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> tax-pool </font><font color="#660096">&gt;</font><font color="#000000"> </font><font color="#963700">0</font><font color="#000000"> [  </font><font color="#5a5a5a">;; Only redistribute if there are turtles and taxes available</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> sorted-turtles </font><font color="#660096">sort-by</font><font color="#000000"> [[a b] -&gt; [sugar] </font><font color="#660096">of</font><font color="#000000"> a </font><font color="#660096">&lt;</font><font color="#000000"> [sugar] </font><font color="#660096">of</font><font color="#000000"> b] </font><font color="#660096">turtles</font><font color="#000000"><br />    </font><font color="#0000aa">let</font><font color="#000000"> agentset-sorted </font><font color="#660096">turtle-set</font><font color="#000000"> sorted-turtles  </font><font color="#5a5a5a">;; Convert list to agentset</font><font color="#000000"><br />    <br />    </font><font color="#0000aa">ask</font><font color="#000000"> agentset-sorted [<br />      </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">+</font><font color="#000000"> (tax-pool </font><font color="#660096">/</font><font color="#000000"> </font><font color="#660096">count</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000">) </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">2</font><font color="#000000"> ]  </font><font color="#5a5a5a">;; Give more to the poorest</font><font color="#000000"><br />      </font><font color="#0000aa">if</font><font color="#000000"> sugar </font><font color="#660096">&gt;=</font><font color="#000000"> </font><font color="#963700">10</font><font color="#000000"> </font><font color="#660096">and</font><font color="#000000"> sugar </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">30</font><font color="#000000"> [ </font><font color="#0000aa">set</font><font color="#000000"> sugar sugar </font><font color="#660096">+</font><font color="#000000"> (tax-pool </font><font color="#660096">/</font><font color="#000000"> </font><font color="#660096">count</font><font color="#000000"> </font><font color="#660096">turtles</font><font color="#000000">) ]  </font><font color="#5a5a5a">;; Normal distribution</font><font color="#000000"><br />    ]<br /><br />    </font><font color="#0000aa">set</font><font color="#000000"> tax-pool </font><font color="#963700">0</font><font color="#000000">  </font><font color="#5a5a5a">;; Reset tax pool after redistribution</font><font color="#000000"><br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> interact-culture<br />  </font><font color="#0000aa">let</font><font color="#000000"> nearby-turtles </font><font color="#660096">turtles-on</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> </font><font color="#660096">in-radius</font><font color="#000000"> vision  </font><font color="#5a5a5a">;; Get neighboring agents</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> nearby-turtles [<br />    </font><font color="#0000aa">let</font><font color="#000000"> partner </font><font color="#660096">one-of</font><font color="#000000"> nearby-turtles<br />    </font><font color="#0000aa">let</font><font color="#000000"> differing-traits </font><font color="#660096">filter</font><font color="#000000"> [ i -&gt; (</font><font color="#660096">item</font><font color="#000000"> i culture) </font><font color="#660096">!=</font><font color="#000000"> (</font><font color="#660096">item</font><font color="#000000"> i [culture] </font><font color="#660096">of</font><font color="#000000"> partner)] (</font><font color="#660096">range</font><font color="#000000"> </font><font color="#660096">length</font><font color="#000000"> culture)<br />    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">not</font><font color="#000000"> </font><font color="#660096">empty?</font><font color="#000000"> differing-traits [<br />      </font><font color="#0000aa">let</font><font color="#000000"> trait-to-change </font><font color="#660096">one-of</font><font color="#000000"> differing-traits<br />      </font><font color="#0000aa">set</font><font color="#000000"> culture </font><font color="#660096">replace-item</font><font color="#000000"> trait-to-change culture (</font><font color="#660096">item</font><font color="#000000"> trait-to-change [culture] </font><font color="#660096">of</font><font color="#000000"> partner)<br />    ]<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#5a5a5a">;to engage-conflict</font><font color="#000000"><br /></font><font color="#5a5a5a">;  let neighbor one-of turtles in-radius 2</font><font color="#000000"><br /></font><font color="#5a5a5a">;  if neighbor != nobody [</font><font color="#000000"><br /></font><font color="#5a5a5a">;    let cultural-diff count (filter [i -&gt; item i culture != item i [culture] of neighbor] range length culture)</font><font color="#000000"><br /></font><font color="#5a5a5a">;    let conflict-chance aggression * cultural-diff / length culture</font><font color="#000000"><br /></font><font color="#5a5a5a">;    if random-float 1 &lt; conflict-chance [</font><font color="#000000"><br /></font><font color="#5a5a5a">;      ifelse aggression &gt; [aggression] of neighbor [</font><font color="#000000"><br /></font><font color="#5a5a5a">;        ask neighbor [ die ] ;; Stronger agent wins</font><font color="#000000"><br /></font><font color="#5a5a5a">;      ][</font><font color="#000000"><br /></font><font color="#5a5a5a">;        die ;; Weaker agent loses</font><font color="#000000"><br /></font><font color="#5a5a5a">;      ]</font><font color="#000000"><br /></font><font color="#5a5a5a">;    ]</font><font color="#000000"><br /></font><font color="#5a5a5a">;  ]</font><font color="#000000"><br /></font><font color="#5a5a5a">;end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> resolve-conflict<br />  </font><font color="#0000aa">let</font><font color="#000000"> opponents </font><font color="#660096">turtles-on</font><font color="#000000"> </font><font color="#660096">patch-here</font><font color="#000000"><br />  </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> opponents [<br />    </font><font color="#0000aa">let</font><font color="#000000"> rival </font><font color="#660096">one-of</font><font color="#000000"> opponents<br />    </font><font color="#0000aa">if</font><font color="#000000"> rival </font><font color="#660096">!=</font><font color="#000000"> </font><font color="#963700">nobody</font><font color="#000000"> [<br />      </font><font color="#0000aa">let</font><font color="#000000"> my-strength sugar </font><font color="#660096">+</font><font color="#000000"> spice<br />      </font><font color="#0000aa">let</font><font color="#000000"> rival-strength [sugar] </font><font color="#660096">of</font><font color="#000000"> rival </font><font color="#660096">+</font><font color="#000000"> [spice] </font><font color="#660096">of</font><font color="#000000"> rival<br />      <br />      </font><font color="#0000aa">if</font><font color="#000000"> my-strength </font><font color="#660096">&gt;</font><font color="#000000"> rival-strength [<br />        </font><font color="#0000aa">ask</font><font color="#000000"> rival [ </font><font color="#0000aa">die</font><font color="#000000"> ] </font><font color="#5a5a5a">;; I win, opponent dies</font><font color="#000000"><br />      ]<br />      </font><font color="#0000aa">if</font><font color="#000000"> my-strength </font><font color="#660096">&lt;</font><font color="#000000"> rival-strength [<br />        </font><font color="#0000aa">move-to</font><font color="#000000"> </font><font color="#660096">one-of</font><font color="#000000"> </font><font color="#660096">patches</font><font color="#000000"> </font><font color="#660096">with</font><font color="#000000"> [</font><font color="#660096">not</font><font color="#000000"> </font><font color="#660096">any?</font><font color="#000000"> </font><font color="#660096">turtles-here</font><font color="#000000">] </font><font color="#5a5a5a">;; I move away</font><font color="#000000"><br />      ]<br />      </font><font color="#5a5a5a">;; If strengths are equal, do nothing (stalemate)</font><font color="#000000"><br />    ]<br />  ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font><font color="#007f69">to</font><font color="#000000"> spread-disease<br />    </font><font color="#0000aa">if</font><font color="#000000"> </font><font color="#660096">random-float</font><font color="#000000"> </font><font color="#963700">1</font><font color="#000000"> </font><font color="#660096">&lt;</font><font color="#000000"> </font><font color="#963700">0.01</font><font color="#000000"> [ </font><font color="#5a5a5a">;; 1% chance per tick to get infected</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> </font><font color="#660096">color</font><font color="#000000"> </font><font color="#963700">black</font><font color="#000000"> </font><font color="#5a5a5a">;; Infected agents turn blue</font><font color="#000000"><br />      </font><font color="#0000aa">set</font><font color="#000000"> sugar-metabolism sugar-metabolism </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">1.2</font><font color="#000000"> <br />      </font><font color="#0000aa">set</font><font color="#000000"> spice-metabolism spice-metabolism </font><font color="#660096">*</font><font color="#000000"> </font><font color="#963700">1.2</font><font color="#000000"><br />    ]<br /></font><font color="#007f69">end</font><font color="#000000"><br /></font>
</pre>
